# v0.1.56 - System Hardening & Thermal Adaptation

**Release Date:** 2026-01-07

This release focuses on system hardening and reliability improvements, particularly for large codebase indexing on Apple Silicon.

---

## Changed

- Change default `TimeoutProgression` from 1.0 to 1.5 for thermal adaptation
  - Optimized for large codebases (98% of users)
  - Increases timeout by 50% per 1000 chunks to handle GPU thermal throttling
  - Fix config `mergeWith()` to properly merge thermal settings from user config

## Fixed

- Fix `.amanmcp.yaml` exclude patterns not being applied ([BUG-050](../bugs/BUG-050-config-exclude-patterns-not-applied.md))
  - Add `dir/**` pattern handling for directory recursive exclusion
  - Add `dir/prefix*.ext` pattern handling with `filepath.Match()` support
  - Supports character class patterns like `[0-9]`
  - Reduces index size by ~34% for amanmcp codebase

- Fix final batch embedding timeout failure at 99% ([BUG-051](../bugs/BUG-051-final-batch-embedding-timeout.md))
  - Initialize batch index correctly on resume for thermal timeout progression
  - Add 1.5x timeout boost for final batch to handle peak thermal throttling
  - Include final batch in cooling delay (was incorrectly skipped)
  - Fix progressive timeout capping that limited late-batch timeouts

- Add serve command hardening to prevent index corruption
  - Add PID file check to prevent multiple serve instances on same project
  - Block serve if incomplete index detected (checkpoint exists)
  - Both protections apply to normal and session mode

- Fix checkpoint save atomicity ([BUG-055](../bugs/BUG-055-checkpoint-save-not-atomic.md))
  - Use single transaction for all checkpoint operations (Save and Clear)
  - Prevents partial checkpoint state on crash or power failure

- Fix hardcoded batch size magic number ([BUG-056](../bugs/BUG-056-hardcoded-batch-size.md))
  - Move `embeddingBatchSize` constant before resume logic
  - Use constant consistently at all division points

- Add SQLite integrity check on startup ([BUG-057](../bugs/BUG-057-no-sqlite-integrity-check.md))
  - Execute `PRAGMA integrity_check` when opening metadata store
  - Log error-level warning if corruption detected with recommended action

- Add startup reconciliation logging ([BUG-054](../bugs/BUG-054-mcp-server-reconciliation-conflicts.md))
  - Log reconciliation start/complete events for debugging
  - Document that search is available during reconciliation

---

## Upgrade Notes

This release enables thermal timeout progression by default. For users who previously relied on the flat 60s timeout, no action is needed - the new progressive timeout only increases wait times, never decreases them.

If you experience issues with the new defaults, you can disable progression:

```yaml
# .amanmcp.yaml
embeddings:
  timeout_progression: 1.0  # Disable progression
```

---

## Technical Details

### Timeout Calculation at 99% Completion (10K chunks)

| Factor | Value |
|--------|-------|
| Base timeout | 60s |
| Progression (1.5^10) | 3.0x (capped) |
| Final batch boost | 1.5x |
| **Total timeout** | **270s** |

This provides 4.5x more headroom for thermal throttling compared to v0.1.55.
