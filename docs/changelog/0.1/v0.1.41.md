# v0.1.41 - 2026-01-04

## MCP Server Connection Fixes

This release fixes critical MCP server connection issues that were preventing Claude Code from connecting to the server.

---

## Fixed

### CRITICAL Priority

- **BUG-035**: MCP server startup timeout causing "file already closed" error in Claude Code
  - Make file watcher startup asynchronous (non-blocking) in both `runServe()` and `runServeWithSession()`
  - MCP server now starts immediately (<500ms), file watcher initializes in background
  - Add `verifyStdinForMCP()` to diagnose stdin availability issues early
  - Add MCP-safe logging to `runServeWithSession()` (was missing from BUG-034 fix)
  - Server now gracefully handles file watcher failures (search still works without live updates)

### HIGH Priority

- **BUG-032**: MCP server only registered `search` tool, missing `search_code`, `search_docs`, and `index_status` - all 4 tools now properly registered with MCP SDK
- **BUG-033**: Server resilience improvements - make MCP server "just work" without crashing
  - Replace panic in `search.New` with error return (new `search.NewEngine` constructor)
  - Add panic recovery to `runServe` and `runServeWithSession`
  - Increase watcher startup timeout from 500ms to 2s for slow filesystems
  - Add debug logging for MCP tool registration
- **BUG-034**: MCP protocol stdout contamination causing "Failed to connect" in Claude Code
  - Remove all stdout writes before MCP JSON-RPC server starts
  - Add `logging.SetupMCPMode()` for file-only logging
  - All startup events now logged to `~/.amanmcp/logs/server.log`

### MEDIUM Priority

- **BUG-036**: Files created/modified/deleted while MCP server was stopped were not detected
  - Add `ReconcileFilesOnStartup()` to detect file changes by comparing indexed metadata
  - New files are indexed, modified files re-indexed, deleted files removed
  - Add `GetFilesForReconciliation()` metadata store method
  - Incremental reconciliation (not full reindex)

### LOW Priority

- **BUG-037**: Shutdown race condition causing "database is closed" warnings
  - Add context cancellation check in `applyFileChanges()` loop
  - Gracefully exit reconciliation when server is shutting down

---

## Added

- `verifyStdinForMCP()` function for early stdin validation
- `ReconcileFilesOnStartup()` for offline file change detection
- `GetFilesForReconciliation()` metadata store method
- Context cancellation handling in file reconciliation
- Comprehensive MCP server startup tests

---

## Documentation

- Add BUG-035 documentation (MCP startup timeout)
- Add BUG-036 documentation (startup file reconciliation)
- Add BUG-037 documentation (shutdown race condition)
- Update bug tracker index

---

## Known Issues

- **BUG-021**: llama.cpp Metal SIGBUS crash - workaround: use static/ollama embedder
- **BUG-024**: HNSW unbounded growth from lazy deletion (deferred)
- **BUG-028**: Full rescan on gitignore change (deferred)
- **BUG-030**: Event buffer overflow drops events (deferred)
