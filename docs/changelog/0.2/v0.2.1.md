# v0.2.1 - 2026-01-10

MLX memory optimization and CR-1 semantic search tuning. Reduces idle memory from 15-35GB to <100MB and improves code search quality.

---

## Added

- MLX lazy loading with TTL auto-unload (FEAT-MEM1): Models load on first request, unload after 5 min idle. Reduces idle memory from 15-35GB to <100MB.
- MLX memory cleanup pattern (TASK-MEM2): Proper GPU memory release via gc.collect() + mx.metal.clear_cache() + mx.synchronize().
- TTL status in /models and /metrics endpoints: Shows idle time and remaining TTL for loaded models.
- Qwen3 query instruction format (RCA-015): Queries now prefixed with Qwen3-required instruction for better semantic retrieval.
- Contextual retrieval `code_chunks` config option (RCA-015): Skip CR-1 prefixes for code chunks. Defaults to false (disabled for code, enabled for docs).

## Changed

- MLX default model changed from 8B to 0.6B (TASK-MEM1): 94% quality retention at 5x less memory (~3GB vs 15-35GB). Prevents system freezes during indexing.
- Search weights (BM25/Semantic) removed from user config (opinionated simplification). Use env vars `AMANMCP_BM25_WEIGHT` and `AMANMCP_SEMANTIC_WEIGHT` for power user override.
- Default search weights changed from BM25=0.35/Semantic=0.65 to BM25=0.65/Semantic=0.35 (RCA-015): Favor keyword matching until vector search quality is improved.

## Fixed

- Add env var override for search weights (`AMANMCP_BM25_WEIGHT`, `AMANMCP_SEMANTIC_WEIGHT`) for investigation and debugging.

## Removed

- `bm25_weight` and `semantic_weight` removed from config.yaml schema. Hardcoded defaults are empirically tuned.

---

## Technical Details

### Memory Optimization

| Metric | Before | After |
|--------|--------|-------|
| Idle memory | 15-35 GB | <100 MB |
| Indexing memory | 15-35 GB | ~3 GB |
| Model load time | At startup | On first request |
| Auto-unload | Never | After 5 min idle |

### Search Quality (RCA-015)

| Query Type | Before | After |
|------------|--------|-------|
| Exact code match | Docs ranked first | Code at rank 1 |
| File path search | Docs ranked first | Correct file rank 1 |
| Natural language | Docs ranked first | Still prefers docs* |

*Natural language queries limited by 0.6B model capacity. BM25 weight increased to compensate.

---

## Related

- RCA-015: Semantic Search Regression
- BUG-RR1: Config Merge Zero Values
- FEAT-MEM1, TASK-MEM2: Memory Optimization
