# v0.10.0 - Lazy Background Compaction

**Release Date:** 2026-01-15

---

## Added

- Lazy background compaction for HNSW vector index (FEAT-AI3)
  - Automatically detects orphan vectors from lazy deletion
  - Triggers compaction during idle periods (no searches for 30s)
  - Threshold-based: only runs when >20% orphans and >100 orphan count
  - Fully interruptible: cancels immediately if search request arrives
  - Zero-config: works out of the box with sensible defaults
  - Configurable via `.amanmcp.yaml` or env vars for power users

---

## Configuration

**Zero-config:** Compaction is enabled by default with sensible values.

**Optional overrides in `.amanmcp.yaml`:**

```yaml
compaction:
  enabled: true              # Default: true
  orphan_threshold: 0.2      # Default: 20% orphans triggers eligibility
  min_orphan_count: 100      # Default: skip small indexes
  idle_timeout: "30s"        # Default: 30s without searches = idle
  cooldown: "1h"             # Default: min 1h between compactions
```

**Environment variables:**
- `AMANMCP_COMPACTION_ENABLED`
- `AMANMCP_COMPACTION_ORPHAN_THRESHOLD`
- `AMANMCP_COMPACTION_IDLE_TIMEOUT`
- `AMANMCP_COMPACTION_COOLDOWN`

---

## Technical Details

### How It Works

1. **Orphan Detection:** HNSW uses lazy deletion - deleted vectors remain as orphan nodes. Detected via `graph.Len() - len(idMap)`.

2. **Idle Trigger:** After 30s of no search activity, compaction becomes eligible.

3. **Threshold Check:** Only triggers when orphans exceed 20% of total nodes AND at least 100 orphans exist.

4. **Rebuild:** Creates fresh HNSW from SQLite-stored embeddings (zero re-embedding cost).

5. **Interruptible:** Cancels immediately if a search request arrives, with no user impact.

6. **Cooldown:** At most once per hour per project to prevent excessive rebuilds.

### Files Changed

| File | Change |
|------|--------|
| `internal/store/hnsw.go` | `HNSWStats` struct + `Stats()` method |
| `internal/config/config.go` | `CompactionConfig` with defaults |
| `internal/daemon/compaction.go` | NEW - CompactionManager |
| `internal/daemon/daemon.go` | Lifecycle + search hooks |

---

## Upgrade Notes

No action required. Compaction runs automatically and invisibly in the background.

---

**Full Changelog:** [v0.9.0...v0.10.0](https://github.com/Aman-CERP/amanmcp/compare/v0.9.0...v0.10.0)
